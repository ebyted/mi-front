{% extends "base.html" %}
{% block title %}Iniciar Sesión{% endblock %}
{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
  <div class="card shadow-lg p-4 animate__animated animate__fadeIn" style="min-width:350px;max-width:400px; border-radius: 1.2rem;">
    <h2 class="mb-4 text-center text-primary"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</h2>
    <form id="loginForm" autocomplete="on">
      <div class="mb-3">
        <label for="email" class="form-label">Correo electrónico</label>
        <input type="email" class="form-control" id="email" name="email" required autofocus aria-label="Correo electrónico">
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Contraseña</label>
        <input type="password" class="form-control" id="password" name="password" required aria-label="Contraseña">
      </div>
      <div id="loginError" class="alert alert-danger py-2 animate__animated animate__shakeX" role="alert" aria-live="assertive" style="display:none;"></div>
      <button type="submit" class="btn btn-primary w-100 shadow-sm" style="font-weight:600; letter-spacing:1px;">Entrar <i class="fas fa-arrow-right ms-2"></i></button>
    </form>
    <script>
      document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        errorDiv.style.display = 'none';

        const formData = new URLSearchParams();
        formData.append('username', email); 
        formData.append('password', password);

        try {
          const response = await fetch('/api/v1/auth/login', {
            method: 'POST',
            body: formData 
          });

          let data = {};
          try {
            data = await response.json();
          } catch (jsonErr) {
            errorDiv.textContent = 'Respuesta inválida del servidor.';
            errorDiv.style.display = 'block';
            console.error('🔴 Error parseando JSON:', jsonErr);
            return;
          }

          if (response.ok && data.access_token) {
            const expires = new Date(Date.now() + 86400e3).toUTCString();
            document.cookie = `access_token=${data.access_token}; path=/; expires=${expires}; samesite=lax`;
            window.location.href = '/admin/executive-dashboard';
          } else {
            errorDiv.textContent = data.detail || 'Credenciales incorrectas.';
            errorDiv.style.display = 'block';
          }
        } catch (err) {
          errorDiv.textContent = 'Error de conexión con el servidor.';
          errorDiv.style.display = 'block';
          console.error('🔴 Error AJAX:', err);
        }
      });
    </script>
    <div class="text-center mt-3" style="font-size:0.95em; color:#888;">
      <i class="fas fa-database"></i> Base de datos en puerto: <span class="fw-bold">{{ DB_PORT if DB_PORT else '5432' }}</span>
    </div>
  </div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}
