{% extends "base.html" %}
{% block title %}Selector de Productos{% endblock %}
{% block content %}
<div class="dashboard-bg p-3 animate__animated animate__fadeIn" style="position: static !important; z-index: auto !important;">
  {% if user_id %}
    <div class="alert alert-success mb-3" role="alert">
      <i class="fas fa-user-check"></i> Usuario autenticado: <strong>{{ user_id }}</strong>
    </div>
  {% else %}
    <div class="alert alert-danger mb-3" role="alert">
      <i class="fas fa-user-times"></i> No has iniciado sesión. El menú está deshabilitado.
    </div>
    <div class="alert alert-warning mb-3" role="alert">
      <i class="fas fa-bug"></i> <strong>DEBUG:</strong> Cookie user_id no encontrada o vacía.
    </div>
  {% endif %}
  <div class="d-flex justify-content-between align-items-center mb-4 animate__animated animate__fadeInDown">
    <h1 class="fw-bold display-5 d-flex align-items-center">
          <span class="me-3"><i class="fas fa-box fa-2x text-primary animate__animated animate__bounceIn"></i></span>
          Selección de Productos para entrada de Almacen
        </h1>
      </div>
      <div class="table-container">
        <!-- Search and Filters -->
        <form class="row g-3 mb-3" id="productFiltersForm">
          <div class="col-md-3">
            <label for="search" class="form-label">Buscar</label>
            <div class="input-group">
              <input type="text" class="form-control" id="search" name="search" placeholder="Nombre, código, código de barras...">

            </div>
          </div>
          <div class="col-md-2">
            <label for="category_id" class="form-label">Categoría</label>
            <select class="form-select" id="category_id" name="category_id">
              <option value="">Todas</option>
              {% for category in categories %}
              <option value="{{ category.id }}" {% if category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label for="brand_id" class="form-label">Marca</label>
            <select class="form-select" id="brand_id" name="brand_id">
              <option value="">Todas</option>
              {% for brand in brands %}
              <option value="{{ brand.id }}" {% if brand_id == brand.id %}selected{% endif %}>{{ brand.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </form>
    <div class="row mb-2">
      <div class="col-md-12 d-flex gap-2 justify-content-end align-items-center">
        <button id="addToListButton" class="btn btn-info btn-lg">
          <i class="fas fa-plus"></i> Agrega a lista
        </button>
        <button id="clearListButton" class="btn btn-warning btn-lg">
          <i class="fas fa-trash"></i> Limpiar lista
        </button>
        <button id="okButton" class="btn btn-success btn-lg">
          <i class="fas fa-check"></i> OK
        </button>
      </div>
    </div>
    <h5>Lista de Productos</h5>
    <div class="table-responsive">
      <div id="productsLoading" class="text-center py-4" style="display:none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <div class="mt-2">Cargando productos...</div>
      </div>
      <table class="table table-striped table-hover" id="productsTable">
        <thead class="table-dark">
          <tr>
            <th><input type="checkbox" id="selectAllProducts"></th>
            <th>ID</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>SKU</th>
            <th>Código Barras</th>
            <th>Categoría</th>
            <th>Marca</th>
            <th>Unidad Base</th>
            <th>Existencia Actual</th>
            <th>Stock Mínimo</th>
            <th>Stock Máximo</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="productsTableBody">
          <!-- Los productos se llenan vía JS -->
        </tbody>
      </table>
    </div>
    <div id="productsEmpty" class="text-center py-5" style="display:none;">
      <i class="fas fa-box fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No se encontraron productos</h5>
      <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
    </div>
  </div>
</div>
<script>
  // --- INICIO DEL BLOQUE JS ---
  function showLoading() {
    document.getElementById('productsLoading').style.display = '';
    document.getElementById('productsEmpty').style.display = 'none';
    document.getElementById('productsTable').style.display = 'none';
  }
  function hideLoading() {
    document.getElementById('productsLoading').style.display = 'none';
    document.getElementById('productsTable').style.display = '';
  }
  function showEmpty() {
    document.getElementById('productsEmpty').style.display = '';
    document.getElementById('productsTable').style.display = 'none';
  }
  function renderProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';
    if (!products || products.length === 0) {
      showEmpty();
      return;
    }
    hideLoading();
    products.forEach(product => {
      const tr = document.createElement('tr');
      // Extraer correctamente los campos anidados
      const category = product.category ? (product.category.name || '') : (product.category_name || '');
      const brand = product.brand ? (product.brand.name || '') : (product.brand_name || '');
      const base_unit = product.base_unit ? (product.base_unit.name || '') : (product.base_unit || '');
      // Si tienes campo existencia, úsalo aquí
      const existencia = typeof product.stock !== 'undefined' ? product.stock : (product.existencia || '');
      tr.innerHTML = `
        <td><input type="checkbox" class="product-checkbox" value="${product.id}"></td>
        <td>${product.id}</td>
        <td>${product.name}</td>
        <td>${product.description || ''}</td>
        <td>${product.sku || ''}</td>
        <td>${product.barcode || ''}</td>
        <td>${category}</td>
        <td>${brand}</td>
        <td>${base_unit}</td>
        <td>${typeof product.stock !== 'undefined' ? product.stock : (product.existencia || '')}</td>
        <td>${product.minimum_stock || ''}</td>
        <td>${product.maximum_stock || ''}</td>
        <td>${product.is_active ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>'}</td>
      `;
      tr.addEventListener('click', function(e) {
        if (e.target.tagName.toLowerCase() === 'input') return;
        const checkbox = tr.querySelector('.product-checkbox');
        checkbox.checked = !checkbox.checked;
      });
      tbody.appendChild(tr);
    });
  }
  async function fetchProducts() {
    showLoading();
    const search = document.getElementById('search').value.trim();
    const category_id = document.getElementById('category_id').value;
    const brand_id = document.getElementById('brand_id').value;
    let url = '/admin/products/json?limit=10';
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (category_id) url += `&category_id=${encodeURIComponent(category_id)}`;
    if (brand_id) url += `&brand_id=${encodeURIComponent(brand_id)}`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Error al cargar productos');
      const products = await res.json();
      renderProducts(products);
    } catch (err) {
      showEmpty();
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    fetchProducts();
    document.getElementById('search').addEventListener('input', fetchProducts);
    document.getElementById('category_id').addEventListener('change', fetchProducts);
    document.getElementById('brand_id').addEventListener('change', fetchProducts);
    document.getElementById('productFiltersForm').addEventListener('submit', function(e) {
      e.preventDefault();
      fetchProducts();
    });
    document.getElementById('selectAllProducts').addEventListener('change', function(e) {
      const checked = e.target.checked;
      document.querySelectorAll('.product-checkbox').forEach(cb => {
        cb.checked = checked;
      });
    });
  });
  // --- Lógica para agregar productos seleccionados a una lista JSON y mostrarla como grid ---
  let selectedProducts = [];

  function getSelectedProductObjects() {
    const checkboxes = document.querySelectorAll('.product-checkbox:checked');
    const products = [];
    checkboxes.forEach(cb => {
      const tr = cb.closest('tr');
      const tds = tr.querySelectorAll('td');
      let brand = tds[7].textContent.trim();
      let base_unit = tds[8].textContent.trim();
      let category = tds[6].textContent.trim();
      // Si el valor es '[object Object]' lo dejamos vacío
      if (brand === '[object Object]') brand = '';
      if (base_unit === '[object Object]') base_unit = '';
      if (category === '[object Object]') category = '';
      products.push({
        id: tds[1].textContent.trim(),
        name: tds[2].textContent.trim(),
        description: tds[3].textContent.trim(),
        sku: tds[4].textContent.trim(),
        barcode: tds[5].textContent.trim(),
        category: category,
        brand: brand,
        base_unit: base_unit,
        minimum_stock: tds[9].textContent.trim(),
        maximum_stock: tds[10].textContent.trim(),
        is_active: tds[11].textContent.includes('Activo')
      });
    });
    return products;
  }

  function updateSelectedProductsDisplay() {
    let container = document.getElementById('selectedProductsContainer');
    if (!container) {
      // Si el contenedor no existe, lo creamos justo debajo de la tabla principal
      const tableContainer = document.querySelector('.table-container');
      container = document.createElement('div');
      container.id = 'selectedProductsContainer';
      tableContainer.appendChild(container);
    }
    if (selectedProducts.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No hay productos seleccionados.</div>';
      return;
    }
    let html = '<h5 class="mt-4 mb-2 text-success"><i class="fas fa-check"></i> Productos Seleccionados</h5>';
    html += '<div class="table-responsive"><table class="table table-bordered" style="background:#eaf6ff;">';
    html += '<thead class="table-info"><tr>' +
      '<th>ID</th>' +
      '<th>Nombre</th>' +
      '<th>Descripción</th>' +
      '<th>SKU</th>' +
      '<th>Código Barras</th>' +
      '<th>Categoría</th>' +
      '<th>Marca</th>' +
      '<th>Unidad Base</th>' +
      '<th>Stock Mínimo</th>' +
      '<th>Stock Máximo</th>' +
      '<th>Estado</th>' +
      '<th>Quitar</th>' +
      '</tr></thead><tbody>';
    selectedProducts.forEach((prod, idx) => {
      html += '<tr>' +
        `<td>${prod.id}</td>` +
        `<td>${prod.name}</td>` +
        `<td>${prod.description}</td>` +
        `<td>${prod.sku}</td>` +
        `<td>${prod.barcode}</td>` +
        `<td>${prod.category || ''}</td>` +
        `<td>${prod.brand || ''}</td>` +
        `<td>${prod.base_unit || ''}</td>` +
        `<td>${prod.minimum_stock}</td>` +
        `<td>${prod.maximum_stock}</td>` +
        `<td>${prod.is_active ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>'}</td>` +
        `<td><button class="btn btn-sm btn-danger" onclick="removeSelectedProduct(${idx})"><i class="fas fa-trash"></i></button></td>` +
        '</tr>';
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  function removeSelectedProduct(idx) {
    selectedProducts.splice(idx, 1);
    updateSelectedProductsDisplay();
  }

  document.getElementById('addToListButton').addEventListener('click', function(e) {
    e.preventDefault();
    const products = getSelectedProductObjects();
    products.forEach(prod => {
      if (!selectedProducts.some(p => p.id === prod.id)) {
        selectedProducts.push(prod);
      }
    });
    updateSelectedProductsDisplay();
  });

  document.getElementById('clearListButton').addEventListener('click', function(e) {
    e.preventDefault();
    selectedProducts = [];
    updateSelectedProductsDisplay();
  });

  document.getElementById('okButton').addEventListener('click', function(e) {
    e.preventDefault();
    if (selectedProducts.length === 0) {
      alert('Selecciona al menos un producto para continuar.');
      return;
    }
    try {
      localStorage.setItem('productos_seleccionados', JSON.stringify(selectedProducts));
      window.location.assign('/confirm_entrada');
    } catch (err) {
      alert('Error al guardar productos seleccionados.');
      console.error('Error localStorage:', err);
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    updateSelectedProductsDisplay();
  });
</script>
{% endblock %}


