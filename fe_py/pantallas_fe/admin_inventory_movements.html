{% extends "base.html" %}

{% block extra_css %}
<style>
.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1050;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.autocomplete-item {
    padding: 0.75rem;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.15s ease-in-out;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover,
.autocomplete-item.active {
    background-color: #f8f9fa !important;
}

.autocomplete-item small {
    font-size: 0.875rem;
}

.autocomplete-item mark {
    background-color: #fff3cd;
    padding: 0.1rem 0.2rem;
    border-radius: 0.2rem;
    color: #856404;
    font-weight: bold;
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// --- Búsqueda y selección de productos para movimientos ---
let selectedProduct = null;
let movementItems = [];
let autocompleteTimeout = null;

// Autocompletado en tiempo real para el campo de búsqueda
document.getElementById('searchProductText').addEventListener('input', function() {
    const query = this.value.trim();
    const dropdown = document.getElementById('autocompleteDropdown');
    
    if (autocompleteTimeout) {
        clearTimeout(autocompleteTimeout);
    }
    
    if (query.length < 2) {
        dropdown.style.display = 'none';
        document.getElementById('searchProductId').value = '';
        return;
    }
    
    autocompleteTimeout = setTimeout(() => {
        fetchAutocompleteSuggestions(query);
    }, 300);
});

// Mostrar sugerencias al hacer foco en el campo
document.getElementById('searchProductText').addEventListener('focus', function() {
    const query = this.value.trim();
    if (query.length >= 2) {
        fetchAutocompleteSuggestions(query);
    } else {
        // Mostrar productos populares o recientes cuando no hay búsqueda
        fetchAutocompleteSuggestions('');
    }
});

// Limpiar selección cuando el usuario cambia el texto manualmente
document.getElementById('searchProductText').addEventListener('input', function() {
    const currentValue = this.value.trim();
    const selectedName = selectedProduct ? selectedProduct.name : '';
    
    if (currentValue !== selectedName) {
        selectedProduct = null;
        document.getElementById('searchProductId').value = '';
    }
});

// Autocompletado con variantes: siempre usar product_variant_id
async function fetchAutocompleteSuggestions(query) {
    let url = `/api/v1/products/search?limit=10`;
    if (query && query.length >= 2) {
        url += `&query=${encodeURIComponent(query)}`;
    }
    const dropdown = document.getElementById('autocompleteDropdown');
    dropdown.innerHTML = '';
    try {
        const res = await fetch(url, { credentials: 'same-origin' });
        const data = await res.json();
        if (!data.length) {
            const noResultsText = query ? 'No se encontraron artículos' : 'No hay artículos disponibles';
            dropdown.innerHTML = `<div class="dropdown-item-text text-muted">${noResultsText}</div>`;
            dropdown.style.display = 'block';
            return;
        }
        for (const product of data) {
            let variants = [];
            try {
                const resVar = await fetch(`/api/v1/products/${product.id}/variants`, { credentials: 'same-origin' });
                if (resVar.ok) {
                    variants = await resVar.json();
                } else {
                    console.warn(`Error al obtener variantes para producto ${product.id}`);
                    variants = [];
                }
            } catch (e) { 
                console.warn(`Error de red al obtener variantes para producto ${product.id}:`, e);
                variants = []; 
            }
            
            if (!variants.length) {
                // Si no hay variantes, usar el producto como variante única
                const item = document.createElement('div');
                item.className = 'dropdown-item autocomplete-item';
                item.style.cursor = 'pointer';
                let displayName = product.name;
                if (query && query.length >= 2) {
                    const regex = new RegExp(`(${query})`, 'gi');
                    displayName = product.name.replace(regex, '<mark>$1</mark>');
                }
                item.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${displayName}</strong>
                            <br><small class="text-info">Variante: (default)</small>
                            <br><small class="text-muted">SKU: ${product.sku || 'N/A'} | Código: ${product.barcode || 'N/A'}</small>
                        </div>
                    </div>
                `;
                item.dataset.variantId = product.id;
                item.dataset.name = product.name;
                item.dataset.sku = product.sku || '';
                item.dataset.barcode = product.barcode || '';
                item.addEventListener('click', function() {
                    selectVariantFromAutocomplete(this);
                });
                dropdown.appendChild(item);
            } else {
                for (const variant of variants) {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item autocomplete-item';
                    item.style.cursor = 'pointer';
                    let displayName = product.name;
                    if (variant.name) displayName += ' - ' + variant.name;
                    if (query && query.length >= 2) {
                        const regex = new RegExp(`(${query})`, 'gi');
                        displayName = displayName.replace(regex, '<mark>$1</mark>');
                    }
                    item.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${displayName}</strong>
                                <br><small class="text-info">Variante: ${variant.name || '(default)'}</small>
                                <br><small class="text-muted">SKU: ${variant.sku || 'N/A'} | Código: ${variant.barcode || 'N/A'}</small>
                            </div>
                        </div>
                    `;
                    item.dataset.variantId = variant.id;
                    item.dataset.name = product.name + (variant.name ? ' - ' + variant.name : '');
                    item.dataset.sku = variant.sku || '';
                    item.dataset.barcode = variant.barcode || '';
                    item.addEventListener('click', function() {
                        selectVariantFromAutocomplete(this);
                    });
                    dropdown.appendChild(item);
                }
            }
        }
        dropdown.style.display = 'block';
    } catch (err) {
        console.error('Error al buscar artículos:', err);
        dropdown.innerHTML = '<div class="dropdown-item-text text-danger">Error al buscar artículos</div>';
        dropdown.style.display = 'block';
    }
}

// Seleccionar variante desde el autocompletado
function selectVariantFromAutocomplete(item) {
    selectedProduct = {
        variant_id: item.dataset.variantId,
        name: item.dataset.name,
        sku: item.dataset.sku,
        barcode: item.dataset.barcode
    };
    document.getElementById('searchProductId').value = selectedProduct.variant_id;
    document.getElementById('searchProductText').value = selectedProduct.name;
    document.getElementById('autocompleteDropdown').style.display = 'none';
    document.getElementById('searchQty').focus();
}

// Agregar producto a la lista de artículos (corregido COMPLETAMENTE)
document.getElementById('addArticleBtn').onclick = function() {
    console.log('=== BOTÓN AGREGAR CLICKED ===');
    
    const variantId = document.getElementById('searchProductId').value;
    const prodName = document.getElementById('searchProductText').value;
    const quantity = parseFloat(document.getElementById('searchQty').value);
    const unitSelect = document.getElementById('searchUnit');
    const unitName = unitSelect.options[unitSelect.selectedIndex].text;
    
    console.log('Datos del formulario:');
    console.log('- variantId:', variantId);
    console.log('- prodName:', prodName);
    console.log('- quantity:', quantity);
    console.log('- unitName:', unitName);
    console.log('- selectedProduct:', selectedProduct);
    
    // Validaciones
    if (!variantId || !prodName) {
        alert('Selecciona un artículo');
        console.log('ERROR: Artículo no seleccionado');
        return;
    }
    if (!quantity || quantity <= 0) {
        alert('Cantidad inválida');
        console.log('ERROR: Cantidad inválida');
        return;
    }
    
    // Verificar si el artículo ya está en la lista
    const existingItem = movementItems.find(item => item.product_variant_id == variantId);
    if (existingItem) {
        if (confirm('Este artículo ya está en la lista. ¿Deseas actualizar la cantidad?')) {
            existingItem.quantity = quantity;
            existingItem.unit_name = unitName;
            console.log('Artículo actualizado:', existingItem);
        } else {
            return;
        }
    } else {
        // Agregar nuevo artículo
        const newItem = {
            product_variant_id: parseInt(variantId),
            name: prodName,
            sku: selectedProduct?.sku || 'N/A',
            barcode: selectedProduct?.barcode || 'N/A',
            quantity: quantity,
            unit_name: unitName
        };
        
        movementItems.push(newItem);
        console.log('Nuevo artículo agregado:', newItem);
        console.log('movementItems actualizado:', movementItems);
    }
    
    // Renderizar tabla
    renderMovementItems();
    
    // Limpiar campos
    document.getElementById('searchProductId').value = '';
    document.getElementById('searchProductText').value = '';
    document.getElementById('searchQty').value = '';
    document.getElementById('searchUnit').selectedIndex = 0;
    selectedProduct = null;
    
    // Enfocar el campo de búsqueda para agregar más artículos
    document.getElementById('searchProductText').focus();
    
    console.log('=== FIN BOTÓN AGREGAR ===');
};

// Función para renderizar la tabla de artículos agregados (CORREGIDA)
function renderMovementItems() {
    console.log('=== RENDERIZANDO TABLA ===');
    console.log('movementItems:', movementItems);
    
    const tbody = document.querySelector('#movementItemsTable tbody');
    if (!tbody) {
        console.error('ERROR: No se encontró el tbody de la tabla');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (movementItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay artículos agregados</td></tr>';
        console.log('Tabla vacía renderizada');
        return;
    }
    
    movementItems.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${item.name}</strong></td>
            <td>${item.sku}</td>
            <td>${item.barcode}</td>
            <td>${item.quantity}</td>
            <td>${item.unit_name}</td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeMovementItem(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        console.log(`Fila ${index} agregada:`, item);
    });
    
    console.log('=== FIN RENDERIZADO ===');
}

// Función para eliminar artículo de la lista (CORREGIDA)
function removeMovementItem(index) {
    console.log('=== ELIMINANDO ITEM ===');
    console.log('Índice a eliminar:', index);
    console.log('movementItems antes:', movementItems);
    
    movementItems.splice(index, 1);
    
    console.log('movementItems después:', movementItems);
    renderMovementItems();
    console.log('=== FIN ELIMINACIÓN ===');
}

// Navegación con teclado en el autocompletado (corregida)
document.getElementById('searchProductText').addEventListener('keydown', function(e) {
    const dropdown = document.getElementById('autocompleteDropdown');
    const items = dropdown.querySelectorAll('.autocomplete-item');
    const current = dropdown.querySelector('.autocomplete-item.active');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!current) {
            if (items.length > 0) {
                items[0].classList.add('active');
                items[0].style.backgroundColor = '#f8f9fa';
            }
        } else {
            current.classList.remove('active');
            current.style.backgroundColor = '';
            const next = current.nextElementSibling;
            if (next && next.classList.contains('autocomplete-item')) {
                next.classList.add('active');
                next.style.backgroundColor = '#f8f9fa';
            }
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (current) {
            current.classList.remove('active');
            current.style.backgroundColor = '';
            const prev = current.previousElementSibling;
            if (prev && prev.classList.contains('autocomplete-item')) {
                prev.classList.add('active');
                prev.style.backgroundColor = '#f8f9fa';
            }
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (current) {
            selectVariantFromAutocomplete(current); // Corregido: usar la función correcta
        }
    } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
    }
});

// Guardar movimiento (CON DEBUGGING SÚPER DETALLADO)
document.getElementById('movementForm').onsubmit = async function(e) {
    e.preventDefault();
    
    console.log('=== SUBMIT ===');
    console.log('movementItems:', movementItems);
    
    if (movementItems.length === 0) {
        alert('Agrega al menos un artículo');
        return false;
    }
    
    const data = {
        movement_type: document.getElementById('movementType').value,
        warehouse_id: parseInt(document.getElementById('warehouse').value),
        reference_number: document.getElementById('reference').value || null,
        notes: document.getElementById('notes').value || null,
        items: movementItems.map(item => ({
            product_variant_id: parseInt(item.product_variant_id),
            quantity: parseFloat(item.quantity),
            unit_name: item.unit_name
        }))
    };
    
    console.log('Enviando:', JSON.stringify(data, null, 2));
    
    try {
        const response = await fetch('/api/v1/inventory-movements/create-json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Éxito:', result);
            alert('Movimiento creado exitosamente');
            
            // Limpiar y cerrar
            movementItems = [];
            renderMovementItems();
            this.reset();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('newMovementModal'));
            if (modal) modal.hide();
            
            window.location.reload();
        } else {
            const error = await response.text();
            console.error('Error:', error);
            alert('Error del servidor: ' + response.status);
        }
    } catch (error) {
        console.error('Error de red:', error);
        alert('Error de conexión: ' + error.message);
    }
    
    return false;
};
</script>
{% endblock %}
{% block style %}
<style>
  .user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-right: 1.5rem;
  }
  .user-info .logout-link {
    color: #dc3545;
    border: 1px solid #dc3545;
    border-radius: 1rem;
    padding: 2px 12px;
    margin-left: 0.5rem;
    font-weight: 500;
    transition: background 0.2s, color 0.2s;
  }
  .user-info .logout-link:hover {
    background: #dc3545;
    color: #fff;
    text-decoration: none;
  }
  .products-badge {
    position: absolute;
    top: 1.5rem;
    right: 2.5rem;
    z-index: 10;
    font-size: 1rem;
    padding: 0.4em 1em;
    border-radius: 1.5em;
    background: #1976d2;
    color: #fff;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.15);
  }
</style>
{% endblock %}

{% block title %}Movimientos de Inventario | Maestro Inventario{% endblock %}

{% block content %}
<!-- Barra de usuario autenticado -->
{% if user_id %}
  <div class="alert alert-success mb-3" role="alert">
    <i class="fas fa-user-check"></i> Usuario autenticado: <strong>{{ user_id }}</strong>
  </div>
  
{% else %}
  <div class="alert alert-danger mb-3" role="alert">
    <i class="fas fa-user-times"></i> No has iniciado sesión. El menú está deshabilitado.
  </div>
  <div class="alert alert-warning mb-3" role="alert">
    <i class="fas fa-bug"></i> <strong>DEBUG:</strong> Cookie user_id no encontrada o vacía.
  </div>
{% endif %}
<div class="d-flex justify-content-between align-items-center mb-4 animate__animated animate__fadeInDown position-relative">
    <h1 class="fw-bold text-primary"><i class="fas fa-exchange-alt"></i> Movimientos de Inventario</h1>
    <div class="user-info">
        <span class="text-muted">Usuario activo</span>
        <a href="/logout" class="logout-link">Cerrar sesión</a>
    </div>
    <div style="position: absolute; top: 0.5rem; right: 0;">
        <!-- Aquí puedes poner el badge de productos si aplica en esta vista -->
        {# <span class="products-badge">2088 productos</span> #}
    </div>
    <div>
        <a href="/admin/inventory-movements/export{% if search or movement_type or product_id or warehouse_id or date_from or date_to %}?search={{ search }}&movement_type={{ movement_type }}&product_id={{ product_id }}&warehouse_id={{ warehouse_id }}&date_from={{ date_from }}&date_to={{ date_to }}{% endif %}" 
           class="btn btn-success shadow">
            <i class="fas fa-file-excel"></i> Exportar a Excel
        </a>
        <button class="btn btn-primary ms-2 shadow" data-bs-toggle="modal" data-bs-target="#newMovementModal">
            <i class="fas fa-plus"></i> Nuevo Movimiento
        </button>
    </div>
</div>

<!-- Estadísticas Modernas -->
<div class="row mb-4 animate__animated animate__fadeIn">
    <div class="col-md-3">
        <div class="card border-0 shadow-lg bg-gradient-primary text-white" style="min-height:120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if stats and stats.total_movements is not none and stats.total_movements > 0 %}
                            <h2 class="fw-bold mb-0">{{ stats.total_movements }}</h2>
                            <span class="fs-6">Total Movimientos</span>
                        {% else %}
                            <div class="text-center">
                                <i class="fas fa-database fa-2x opacity-50 mb-2"></i>
                                <div class="small">Sin datos</div>
                            </div>
                        {% endif %}
                    </div>
                    <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-lg bg-gradient-success text-white" style="min-height:120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if stats and stats.movements_in is not none and stats.movements_in > 0 %}
                            <h2 class="fw-bold mb-0">{{ stats.movements_in }}</h2>
                            <span class="fs-6">Entradas</span>
                        {% else %}
                            <div class="text-center">
                                <i class="fas fa-arrow-down fa-2x opacity-25 mb-2"></i>
                                <div class="small">Sin datos</div>
                            </div>
                        {% endif %}
                    </div>
                    <i class="fas fa-arrow-down fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-lg bg-gradient-danger text-white" style="min-height:120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if stats and stats.movements_out is not none and stats.movements_out > 0 %}
                            <h2 class="fw-bold mb-0">{{ stats.movements_out }}</h2>
                            <span class="fs-6">Salidas</span>
                        {% else %}
                            <div class="text-center">
                                <i class="fas fa-arrow-up fa-2x opacity-25 mb-2"></i>
                                <div class="small">Sin datos</div>
                            </div>
                        {% endif %}
                    </div>
                    <i class="fas fa-arrow-up fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-lg bg-gradient-info text-white" style="min-height:120px;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if stats and stats.movements_today is not none and stats.movements_today > 0 %}
                            <h2 class="fw-bold mb-0">{{ stats.movements_today }}</h2>
                            <span class="fs-6">Hoy</span>
                        {% else %}
                            <div class="text-center">
                                <i class="fas fa-calendar-day fa-2x opacity-25 mb-2"></i>
                                <div class="small">Sin datos</div>
                            </div>
                        {% endif %}
                    </div>
                    <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Avanzados Modernos -->
<div class="card mb-4 animate__animated animate__fadeInUp">
    <div class="card-header bg-light border-bottom">
        <h5 class="mb-0 text-primary"><i class="fas fa-filter"></i> Filtros Avanzados</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="search" class="form-label fw-semibold">Buscar</label>
                <input type="text" class="form-control shadow-sm" id="search" name="search" 
                       value="{{ search }}" placeholder="Producto, SKU o referencia...">
            </div>
            <div class="col-md-2">
                <label for="movement_type" class="form-label fw-semibold">Tipo</label>
                <select class="form-select shadow-sm" name="movement_type">
                    <option value="">Todos</option>
                    {% for type in movement_types %}
                        <option value="{{ type.value }}" {% if movement_type == type.value %}selected{% endif %}>
                            {{ type.label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="product_id" class="form-label fw-semibold">Producto</label>
                <select class="form-select shadow-sm" name="product_id">
                    <option value="">Todos los productos</option>
                    {% for product in products %}
                        <option value="{{ product.id }}" {% if product_id == product.id %}selected{% endif %}>
                            {{ product.name }} ({{ product.code }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="warehouse_id" class="form-label fw-semibold">Almacén</label>
                <select class="form-select shadow-sm" name="warehouse_id">
                    <option value="">Todos</option>
                    {% for warehouse in warehouses %}
                        <option value="{{ warehouse.id }}" {% if warehouse_id == warehouse.id %}selected{% endif %}>
                            {{ warehouse.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label for="date_from" class="form-label fw-semibold">Desde</label>
                <input type="date" class="form-control shadow-sm" id="date_from" name="date_from" value="{{ date_from or '' }}">
            </div>
            <div class="col-md-1">
                <label for="date_to" class="form-label fw-semibold">Hasta</label>
                <input type="date" class="form-control shadow-sm" id="date_to" name="date_to" value="{{ date_to or '' }}">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary me-2 shadow">
                    <i class="fas fa-search"></i> Filtrar
                </button>
                <a href="/admin/inventory-movements" class="btn btn-outline-secondary shadow">
                    <i class="fas fa-times"></i> Limpiar Filtros
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tabla de Movimientos -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Movimientos de Inventario ({{ total }} total)</h5>
    </div>
    <div class="card-body">
        {% if movements %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Producto</th>
                            <th>Almacén</th>
                            <th>Cantidad</th>
                            <th>Stock</th>
                            <th>Referencia</th>
                            <th>Notas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movement in movements %}
                        <tr>
                            <td>{{ movement.created_at | datetime }}</td>
                            <td>
                                {% if movement.movement_type.value == 'entry' %}
                                    <span class="badge bg-success">Entrada</span>
                                {% elif movement.movement_type.value == 'exit' %}
                                    <span class="badge bg-danger">Salida</span>
                                {% elif movement.movement_type.value == 'transfer' %}
                                    <span class="badge bg-info">Transferencia</span>
                                {% elif movement.movement_type.value == 'adjustment' %}
                                    <span class="badge bg-warning">Ajuste</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if movement.product_variant and movement.product_variant.product %}
                                    <strong>{{ movement.product_variant.product.name }}</strong>
                                    {% if movement.product_variant.product.sku %}
                                        <br><small class="text-muted">{{ movement.product_variant.product.sku }}</small>
                                    {% endif %}
                                    {% if movement.product_variant.name %}
                                        <br><small class="text-info">{{ movement.product_variant.name }}</small>
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ movement.warehouse.name if movement.warehouse else '-' }}</td>
                            <td>
                                {% if movement.movement_type.value == 'entry' %}
                                    <span class="text-success">+{{ movement.quantity }}</span>
                                {% elif movement.movement_type.value == 'exit' %}
                                    <span class="text-danger">-{{ movement.quantity }}</span>
                                {% else %}
                                    {{ movement.quantity }}
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ movement.previous_quantity if movement.previous_quantity is not none else '-' }} → </small>
                                <strong>{{ movement.new_quantity if movement.new_quantity is not none else '-' }}</strong>
                            </td>
                            <td>{{ movement.reference_number or '-' }}</td>
                            <td>
                                {% if movement.notes %}
                                    <small title="{{ movement.notes }}">{{ movement.notes[:30] }}{% if movement.notes|length > 30 %}...{% endif %}</small>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            {% if total_pages > 1 %}
            <nav>
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page - 1 }}&search={{ search }}&movement_type={{ movement_type }}&product_id={{ product_id or '' }}&warehouse_id={{ warehouse_id or '' }}&date_from={{ date_from }}&date_to={{ date_to }}&per_page={{ per_page }}">Anterior</a>
                        </li>
                    {% endif %}
                    
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                        {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 2 and p <= page + 2) %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ p }}&search={{ search }}&movement_type={{ movement_type }}&product_id={{ product_id or '' }}&warehouse_id={{ warehouse_id or '' }}&date_from={{ date_from }}&date_to={{ date_to }}&per_page={{ per_page }}">{{ p }}</a>
                            </li>
                        {% elif p == 4 or p == total_pages - 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page + 1 }}&search={{ search }}&movement_type={{ movement_type }}&product_id={{ product_id or '' }}&warehouse_id={{ warehouse_id or '' }}&date_from={{ date_from }}&date_to={{ date_to }}&per_page={{ per_page }}">Siguiente</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontraron movimientos</h5>
                <p class="text-muted">No hay movimientos que coincidan con los filtros aplicados</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal Nuevo Movimiento -->
<div class="modal fade" id="newMovementModal" tabindex="-1">
    <div class="modal-dialog modal-xxl" style="max-width: 1400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Movimiento de Inventario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="movementForm">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="movementType" class="form-label">Tipo de Movimiento</label>
                            <select class="form-select" id="movementType" name="movement_type" required>
                                <option value="entry">Entrada</option>
                                <option value="exit">Salida</option>
                                <option value="adjustment">Ajuste</option>
                                <option value="transfer">Transferencia</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="warehouse" class="form-label">Almacén</label>
                            <select class="form-select" id="warehouse" name="warehouse_id" required>
                                {% for warehouse in warehouses %}
                                    <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="reference" class="form-label">Referencia</label>
                            <input type="text" class="form-control" id="reference" name="reference_number">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="notes" class="form-label">Notas</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <hr>
                    <h6>Artículos</h6>
                    <!-- Buscador y agregador de artículos -->
    <div class="row mb-2 align-items-end" id="add-article-row">
        <div class="col-lg-5 col-md-6 mb-2 mb-lg-0 d-flex gap-2 position-relative">
            <div class="position-relative flex-grow-1">
                <input type="text" class="form-control" id="searchProductText" placeholder="Buscar artículo..." autocomplete="off">
                <div class="dropdown-menu autocomplete-dropdown w-100" id="autocompleteDropdown" style="display: none; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <button type="button" class="btn btn-outline-primary" id="openProductSearchModal" style="display: none;"><i class="fas fa-search"></i> Buscar artículo</button>
            <input type="hidden" id="searchProductId">
        </div>
        <div class="col-lg-2 col-md-3 mb-2 mb-lg-0">
            <input type="number" class="form-control" id="searchQty" min="0.01" step="0.01" placeholder="Cantidad">
        </div>
        <div class="col-lg-2 col-md-3 mb-2 mb-lg-0">
            <select class="form-select" id="searchUnit">
                {% for unit in units %}
                    <option value="{{ unit.id }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-lg-3 col-md-12">
            <button type="button" class="btn btn-success w-100" id="addArticleBtn"><i class="fas fa-plus"></i> Agregar a lista</button>
        </div>
    </div>

    <!-- Modal de búsqueda avanzada de artículos -->
    <div class="modal fade" id="productSearchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar y seleccionar artículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-2">
                        <div class="col-md-5">
                            <input type="text" class="form-control" id="productSearchInput" placeholder="Buscar por nombre, SKU, código de barras...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="productSearchCategory">
                                <option value="">Todas las categorías</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="productSearchBrand">
                                <option value="">Todas las marcas</option>
                                {% for brand in brands %}
                                <option value="{{ brand.id }}">{{ brand.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height:350px;overflow:auto;">
                        <table class="table table-hover table-bordered" id="productSearchTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Artículo</th>
                                    <th>SKU</th>
                                    <th>Código Barras</th>
                                    <th>Categoría</th>
                                    <th>Marca</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center text-muted">Escribe para buscar productos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Tabla de artículos agregados -->
<div class="table-responsive mb-2">
    <table class="table table-bordered table-sm align-middle" id="movementItemsTable">
        <thead class="table-light">
            <tr>
                <th>Artículo</th>
                <th>SKU</th>
                <th>Código Barras</th>
                <th>Cantidad</th>
                <th>Unidad</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Guardar Movimiento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

</script>
{% endblock %}
